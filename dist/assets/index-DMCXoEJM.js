(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();class d{constructor(){Detector.webgl||Detector.addGetWebGLMessage(),this.modes=Object.freeze({NONE:Symbol("none"),PRELOAD:Symbol("preload"),INITIALISING:Symbol("initialising")}),this.mode=this.modes.NONE,this.container,this.player={},this.camera,this.scene,this.renderer,this.container=document.createElement("div"),this.container.style.height="100%",document.body.appendChild(this.container);const t=this;this.mode=this.modes.PRELOAD,this.clock=new THREE.Clock,t.init(),t.animate(),window.onError=function(n){console.error(JSON.stringify(n))}}set activeCamera(t){this.player.cameras.active=t}init(){this.mode=this.modes.INITIALISING,this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2e3),this.scene=new THREE.Scene;let t=new THREE.DirectionalLight(16777215,1);t.position.set(0,1,0),this.scene.add(t);let n=new THREE.AmbientLight(16777215,.5);this.scene.add(n);let e=new THREE.SpotLight(16777215,.5);e.position.set(0,500,0),e.angle=Math.PI/4,e.penumbra=.05,e.decay=2,e.distance=200,this.scene.add(e);var i=new THREE.Mesh(new THREE.PlaneBufferGeometry(2e3,2e3),new THREE.MeshPhongMaterial({color:10066329,depthWrite:!1}));i.rotation.x=-Math.PI/2,i.receiveShadow=!0,this.scene.add(i);var s=new THREE.GridHelper(2e3,40,0,0);s.material.opacity=.2,s.material.transparent=!0,this.scene.add(s);const o=this;var a=new THREE.SphereGeometry(15*3,32*3,16*3),c=new THREE.MeshBasicMaterial({color:10354688}),r=new THREE.Mesh(a,c);r.name="Character",r.visible=!1,o.scene.add(r),o.player.object=r,o.joystick=new h({onMove:o.playerControl,game:o}),o.createCameras(),o.loadEnvironment(),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",function(){o.onWindowResize()},!1),this.debug&&(this.stats=new Stats,this.container.appendChild(this.stats.dom))}loadEnvironment(){new THREE.GLTFLoader().load("/glb/base.glb",n=>{const e=n.scene;e.scale.set(80,80,80),this.scene.add(e),n.scene.traverse(function(i){i.isMesh&&(i.name.includes("main")?(i.castShadow=!0,i.receiveShadow=!0,i.material.roughness=.8,i.material.metalness=.5):i.name.includes("Cube")&&(game.environmentProxy=i))})})}playerControl(t,n){n=-n,t==0&&n==0?delete this.player.move:this.player.move={forward:t,turn:n}}createCameras(){const t=new THREE.Object3D;t.position.set(0,150,-100),t.quaternion.set(-.001079297317118498,-.9994228131639347,.031748701462123836,-.031856610911161515),t.parent=this.player.object,this.player.cameras={back:t},this.activeCamera=this.player.cameras.back}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}movePlayer(t){const n=this.player.object.position.clone();n.y+=60;let e=new THREE.Vector3;this.player.object.getWorldDirection(e),this.player.move.forward<0&&e.negate();let i=new THREE.Raycaster(n,e),s=!1;const o=this.environmentProxy;if(this.environmentProxy!=null){const a=i.intersectObject(o);a.length>0&&a[0].distance<50&&(s=!0)}if(!s)if(this.player.move.forward>0){const a=this.player.action=="run"?200:100;this.player.object.translateZ(t*a)}else this.player.object.translateZ(-t*30);if(this.environmentProxy!=null){e.set(-1,0,0),e.applyMatrix4(this.player.object.matrix),e.normalize(),i=new THREE.Raycaster(n,e);let a=i.intersectObject(o);a.length>0&&a[0].distance<50&&this.player.object.translateX(50-a[0].distance),e.set(1,0,0),e.applyMatrix4(this.player.object.matrix),e.normalize(),i=new THREE.Raycaster(n,e),a=i.intersectObject(o),a.length>0&&a[0].distance<50&&this.player.object.translateX(a[0].distance-50),e.set(0,-1,0),n.y+=200,i=new THREE.Raycaster(n,e);const c=30;if(a=i.intersectObject(o),a.length>0){const r=n.y-a[0].distance;r>this.player.object.position.y?(this.player.object.position.y=.8*this.player.object.position.y+.2*r,this.player.velocityY=0):r<this.player.object.position.y&&(this.player.velocityY==null&&(this.player.velocityY=0),this.player.velocityY+=t*c,this.player.object.position.y-=this.player.velocityY,this.player.object.position.y<r&&(this.player.velocityY=0,this.player.object.position.y=r))}}}animate(){const t=this,n=this.clock.getDelta();requestAnimationFrame(function(){t.animate()}),this.player.move!=null&&(this.player.move.forward!=0&&this.movePlayer(n),this.player.object.rotateY(this.player.move.turn*n)),this.player.cameras!=null&&this.player.cameras.active!=null&&(this.camera.position.lerp(this.player.cameras.active.getWorldPosition(new THREE.Vector3),.05),this.camera.quaternion.slerp(this.player.cameras.active.getWorldQuaternion(new THREE.Quaternion),.05)),this.renderer.render(this.scene,this.camera),this.stats!=null&&this.stats.update()}}class h{constructor(t){const n=document.createElement("div");n.style.cssText="position:absolute; bottom:35px; width:80px; height:80px; background:rgba(126, 126, 126, 0.5); border:#444 solid medium; border-radius:50%; left:50%; transform:translateX(-50%);";const e=document.createElement("div");if(e.style.cssText="position: absolute; left: 20px; top: 20px; width: 40px; height: 40px; border-radius: 50%; background: #fff;",n.appendChild(e),document.body.appendChild(n),this.domElement=e,this.maxRadius=t.maxRadius||40,this.maxRadiusSquared=this.maxRadius*this.maxRadius,this.onMove=t.onMove,this.game=t.game,this.origin={left:this.domElement.offsetLeft,top:this.domElement.offsetTop},this.domElement!=null){const i=this;"ontouchstart"in window?this.domElement.addEventListener("touchstart",function(s){i.tap(s)}):this.domElement.addEventListener("mousedown",function(s){i.tap(s)})}}getMousePosition(t){let n=t.targetTouches?t.targetTouches[0].pageX:t.clientX,e=t.targetTouches?t.targetTouches[0].pageY:t.clientY;return{x:n,y:e}}tap(t){t=t||window.event,this.offset=this.getMousePosition(t);const n=this;"ontouchstart"in window?(document.ontouchmove=function(e){n.move(e)},document.ontouchend=function(e){n.up(e)}):(document.onmousemove=function(e){n.move(e)},document.onmouseup=function(e){n.up(e)})}move(t){t=t||window.event;const n=this.getMousePosition(t);let e=n.x-this.offset.x,i=n.y-this.offset.y;const s=e*e+i*i;if(s>this.maxRadiusSquared){const c=Math.sqrt(s);e/=c,i/=c,e*=this.maxRadius,i*=this.maxRadius}this.domElement.style.top=`${i+this.domElement.clientHeight/2}px`,this.domElement.style.left=`${e+this.domElement.clientWidth/2}px`;const o=-(i-this.origin.top+this.domElement.clientHeight/2)/this.maxRadius,a=(e-this.origin.left+this.domElement.clientWidth/2)/this.maxRadius;this.onMove!=null&&this.onMove.call(this.game,o,a)}up(t){"ontouchstart"in window?(document.ontouchmove=null,document.touchend=null):(document.onmousemove=null,document.onmouseup=null),this.domElement.style.top=`${this.origin.top}px`,this.domElement.style.left=`${this.origin.left}px`,this.onMove.call(this.game,0,0)}}document.addEventListener("DOMContentLoaded",function(){const l=new d;window.game=l});
